<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMD - Tuned Mass Damper</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 20px; color: #333; background-color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Estilos de controles idénticos al FFT */
        .controls { 
            background: #f4f4f4; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; align-items: center;
        }
        .control-group { display: flex; flex-direction: column; }
        
        label { font-size: 0.9em; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        /* Estilos para la fórmula MathML */
        .equation-box {
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            overflow-x: auto; /* Para pantallas muy pequeñas */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* Gráfico */
        #plot { width: 100%; height: 500px; border: 1px solid #eee; }

        /* Valor dinámico */
        .val-display { color: #007bff; font-family: monospace; }
    </style>
</head>

<body>

<div class="container">
    <h2>Tuned Mass Damper Optimization</h2>
    
    <div class="equation-box">
        <math display="block">
          <mi>H</mi><mo>=</mo>
          <msqrt>
            <mfrac>
              <mrow>
                <msup>
                  <mrow>
                    <mo>(</mo>
                    <msup><mi>&eta;</mi><mn>2</mn></msup>
                    <mo>−</mo>
                    <msup><mi>&gamma;</mi><mn>2</mn></msup>
                    <mo>)</mo>
                  </mrow>
                  <mn>2</mn>
                </msup>
                <mo>+</mo>
                <mn>4</mn>
                <msup><msub><mi>&xi;</mi><mi>d</mi></msub><mn>2</mn></msup>
                <msup><mi>&gamma;</mi><mn>2</mn></msup>
                <msup><mi>&eta;</mi><mn>2</mn></msup>
              </mrow>

              <mrow>
                <msup>
                  <mrow>
                    <mo>(</mo>
                    <mrow>
                      <mo>(</mo>
                      <msup><mi>&eta;</mi><mn>2</mn></msup>
                      <mo>−</mo>
                      <msup><mi>&gamma;</mi><mn>2</mn></msup>
                      <mo>)</mo>
                    </mrow>
                    <mo>(</mo>
                    <mn>1</mn><mo>−</mo><msup><mi>&gamma;</mi><mn>2</mn></msup>
                    <mo>)</mo>
                    <mo>−</mo>
                    <mi>&rho;</mi>
                    <msup><mi>&gamma;</mi><mn>2</mn></msup>
                    <msup><mi>&eta;</mi><mn>2</mn></msup>
                    <mo>)</mo>
                  </mrow>
                  <mn>2</mn>
                </msup>

                <mo>+</mo>

                <msup>
                  <mrow>
                    <mo>(</mo>
                    <mn>2</mn>
                    <msub><mi>&xi;</mi><mi>d</mi></msub>
                    <mi>&gamma;</mi>
                    <mi>&eta;</mi>
                    <mo>(</mo>
                    <mn>1</mn><mo>−</mo>
                    <msup><mi>&gamma;</mi><mn>2</mn></msup>
                    <mo>(</mo><mn>1</mn><mo>+</mo><mi>&rho;</mi><mo>)</mo>
                    <mo>)</mo>
                    <mo>)</mo>
                  </mrow>
                  <mn>2</mn>
                </msup>
              </mrow>
            </mfrac>
          </msqrt>

          <mspace width="1em"/>
          <mo>;</mo>
          <mspace width="2em"/>
          <mi>&rho;</mi><mo>=</mo>
          <mfrac><msub><mi>m</mi><mi>d</mi></msub><mi>m</mi></mfrac>
          <mspace width="1em"/>
          <mo>;</mo>
          <mspace width="1em"/>
          <mi>&eta;</mi><mo>=</mo>
          <mfrac><msub><mi>&omega;</mi><mi>d</mi></msub><mi>&omega;</mi></mfrac>
        </math>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Mass ratio (ρ) <span id="rho_tag" class="val-display">0.05</span></label>
            <input type="range" id="rho" min="0" max="0.1" step="0.001" value="0.05">
        </div>
        <div class="control-group">
            <label>Damped freq. ratio (η) <span id="eta_tag" class="val-display">0.975</span></label>
            <input type="range" id="eta" min="0.8" max="1.2" step="0.001" value="0.975">
        </div>
        <div class="control-group">
            <label>Damping (ξd) <span id="xi_tag" class="val-display">0.10</span></label>
            <input type="range" id="xi" min="0" max="0.5" step="0.001" value="0.10">
        </div>
    </div>

    <div id="plot"></div>
</div>

<script>
// Referencias a elementos del DOM
const elRho = document.getElementById("rho");
const elEta = document.getElementById("eta");
const elXi = document.getElementById("xi");
const tagRho = document.getElementById("rho_tag");
const tagEta = document.getElementById("eta_tag");
const tagXi = document.getElementById("xi_tag");

function calculateCurve(rho, eta, xi) {
    let x = [];
    let y = [];
    let z = [];
    
    // Generar datos: gamma de 0 a 3
    for (let i = 0; i <= 3; i += 0.01) {
        let gamma = i; // gamma = w/wn
        let gamma2 = gamma * gamma;
        let eta2 = eta * eta;
        
        // Cálculo simplificado de términos
        let a = eta2 - gamma2;
        let b = 2 * xi * gamma * eta;
        
        let num = a*a + b*b;
        
        let term1 = a * (1 - gamma2) - rho * gamma2 * eta2;
        let term2 = b * (1 - gamma2 * (1 + rho));
        
        let den = term1*term1 + term2*term2;
        
        let H = Math.sqrt(num / den);
        
        // Curva base (No Mass Damper) para referencia visual
        // H_base = 1 / |1 - gamma^2|
        let f = Math.abs(1 - gamma2);
        
        x.push(gamma);
        y.push(H);
        // Evitamos la asíntota infinita visualmente
        z.push((f < 0.02) ? null : 1/f); 
    }
    return { x, y, z };
}

function updatePlot() {
    // Leer valores
    let rho = parseFloat(elRho.value);
    let eta = parseFloat(elEta.value);
    let xi = parseFloat(elXi.value);

    // Actualizar etiquetas visuales
    tagRho.innerText = rho.toFixed(3);
    tagEta.innerText = eta.toFixed(3);
    tagXi.innerText = xi.toFixed(3);

    // Calcular
    const data = calculateCurve(rho, eta, xi);

    // Configuración Plotly
    const traceTMD = {
        x: data.x,
        y: data.y,
        name: "With TMD (H)",
        mode: "lines",
        line: { width: 3, color: '#1f77b4' }
    };

    const traceNoTMD = {
        x: data.x,
        y: data.z,
        name: "No TMD",
        mode: "lines",
        fill: "tozeroy",
        fillcolor: "rgba(220, 50, 50, 0.1)",
        line: { width: 1, color: 'rgba(220, 50, 50, 0.5)', dash: 'dot' },
        hoverinfo: "none"
    };

    const layout = {
        title: "Dynamic Magnification Factor vs Frequency Ratio",
        xaxis: { 
            title: "Frequency Ratio γ (Ω/ω)", 
            range: [0, 2.5] 
        },
        yaxis: { 
            title: "Magnification Factor H", 
            range: [0, 10] 
        },
        margin: { t: 50, b: 50, l: 60, r: 20 },
        legend: { x: 0.7, y: 0.9 },
        // Fondo limpio
        plot_bgcolor: "#fff",
        paper_bgcolor: "#fff"
    };

    const config = { responsive: true, displayModeBar: true };

    Plotly.react("plot", [traceNoTMD, traceTMD], layout, config);
}

// Listeners
elRho.addEventListener("input", updatePlot);
elEta.addEventListener("input", updatePlot);
elXi.addEventListener("input", updatePlot);

// Inicializar
updatePlot();

// Ajuste automático al redimensionar ventana
window.addEventListener('resize', () => {
    Plotly.Plots.resize(document.getElementById("plot"));
});
</script>

</body>
</html>